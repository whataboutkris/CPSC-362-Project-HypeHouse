{% extends 'ui/base.html' %}
{% block title %}HypeHouse - Dashboard{% endblock %}

{% block content %}
<sl-tab-group activation="manual" default-panel="Listings">
  <sl-tab slot="nav" panel="Listings" class="text-lg font-semibold">Listings</sl-tab>
  <sl-tab slot="nav" panel="Bookings" class="text-lg font-semibold">Bookings</sl-tab>

<!-- Listings Panel -->
<sl-tab-panel name="Listings">
  <div class="flex justify-center mb-6 space-x-4">
    <!-- Search Bar with Magnifying Glass Icon -->
    <div class="relative w-full max-w-lg">
      <input 
        type="text" 
        id="searchBar" 
        class="sl-input w-full pl-10 pr-24 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
        placeholder="Search listings by name or price (e.g., <10 or >10)"
        oninput="filterListings()"
      >
      <!-- Magnifying Glass Icon -->
      <img src="https://cdn-icons-png.flaticon.com/512/4475/4475396.png" 
           alt="Search Icon" 
           class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500">
    </div>
    <!-- Filter by Name or Price -->
    <select id="filterBy" class="sl-select w-40 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      <option value="name">Name</option>
      <option value="price">Price</option>
    </select>
  </div>

<!-- Listings Container -->
<div class="mt-6 flex flex-wrap gap-6 justify-center">
  {% for listing in listings %}
    <sl-card 
      class="listing-card House-Overview bg-white shadow-lg rounded-lg w-72 p-4 hover:scale-105 transition-transform duration-300 cursor-pointer" 
      data-title="{{ listing.title }}" 
      data-price="{{ listing.price }}" 
      onclick="openListingModal('{{ listing.id }}')"
    >
      <img 
        src="{{ listing.photos.split(',')[0] if listing.photos else 'https://via.placeholder.com/500x300' }}" 
        alt="Rental Image"
        class="w-full h-48 object-cover rounded-lg mb-4" 
      />

      <div class="text-lg font-semibold mb-2">{{ listing.title }}</div>
      <small class="text-gray-600">${{ listing.price }} per night</small><br />
      <p class="text-gray-500 text-sm mt-2">
        {{ listing.description[:80] }}
        {% if listing.description|length > 80 %}...{% endif %}
      </p>

      <div slot="footer" class="mt-4 flex justify-between items-center">
        <a href="{{ url_for('bookings.booking_page', id=listing.id) }}" target="_blank" onclick="event.stopPropagation();">
          <sl-button variant="primary" pill>Book</sl-button>
        </a>

        <sl-button variant="danger" pill class="delete-button" data-listing-id="{{ listing.id }}" onclick="event.stopPropagation();">
          Delete
        </sl-button>
      </div>
    </sl-card>
  {% else %}
    <p class="text-gray-600 text-center">You have no listings. Add one below!</p>
  {% endfor %}
</div>

    <!-- Listing Creation Button moved below cards -->
    <div class="mt-6 flex justify-center">
      <sl-button variant="primary" onclick="openListingDialog()" class="mb-6">+ Add Listing</sl-button>
    </div>
  </sl-tab-panel>

  <!-- Bookings Panel -->
  <sl-tab-panel name="Bookings">
  
    <div class="mt-6 flex flex-wrap gap-6 justify-center">
      {% for booking in bookings %}
        <sl-card class="House-Overview bg-white shadow-lg rounded-lg w-72 p-4">
          <img 
            src="{{ booking.listing.photos.split(',')[0] if booking.listing.photos else 'https://via.placeholder.com/500x300' }}" 
            alt="Booking Image"
            class="w-full h-48 object-cover rounded-lg mb-4" />
  
          <div class="text-lg font-semibold mb-2">{{ booking.listing.title }}</div>
          <small class="text-gray-600">{{ booking.start_date.strftime('%B %d') }} â€“ {{ booking.end_date.strftime('%B %d') }}</small><br />
          <small class="text-gray-600">Hosted by: {{ booking.listing.name }}</small><br />
  
          <div slot="footer" class="mt-4">
            <a href="{{ url_for('bookings.inbox', booking_id=booking.id) }}" onclick="event.stopPropagation();">
              <sl-button variant="success" pill>Open Chat</sl-button>
            </a>
            <sl-button variant="danger" pill onclick="cancelBooking('{{ booking.id }}', this)">Cancel</sl-button>
          </div>
        </sl-card>
      {% else %}
        <p class="text-gray-600 text-center">You have no bookings yet. Book a stay!</p>
      {% endfor %}
    </div>
  </sl-tab-panel>

<!-- Modal for Showing Listing Details -->
<sl-dialog id="listingModal" label="Listing Details" class="listing-modal">
  <div id="listingModalContent"></div>
</sl-dialog>

<!-- Listing Form Dialog -->
<sl-dialog id="listingDialog" label="Create New Listing" class="listing-form-dialog" style="--width: 500px">
  <form id="createListingForm">
    <sl-input name="title" label="Title" required class="mb-4"></sl-input>
    <sl-input name="name" label="Name" required class="mb-4"></sl-input>
    <sl-textarea name="description" label="Description" required class="mb-4"></sl-textarea>
    <sl-input name="photos" label="Photo URL(s) (comma-separated)" required class="mb-4"></sl-input>
    <sl-input name="price" label="Price per night" type="number" step="0.01" required class="mb-4"></sl-input>
    <sl-input name="host_id" label="Your Host ID" type="number" required class="mb-4"></sl-input>
    <sl-button type="submit" variant="success">Submit</sl-button>
  </form>
</sl-dialog>

<!-- Styling -->
<style>.House-Overview {
    max-width: 320px;
    color: var(--sl-color-neutral-500);
    transition: transform 0.3s ease;
  }.House-Overview:hover {
    transform: scale(1.05);
  }.House-Overview img {
    height: 250px;
    object-fit: cover;
    border-radius: 8px;
  }.card-overview [slot='footer'] {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
</style>

<!-- Script -->
<script>
  //Filtering Script
  function filterListings() {
    const searchValue = document.getElementById('searchBar').value.trim();
    const filterBy = document.getElementById('filterBy').value;
    const listings = document.querySelectorAll('.listing-card');
    const isPriceFilter = filterBy === 'price';
    
    listings.forEach(listing => {
      const title = listing.getAttribute('data-title').toLowerCase();
      const price = parseFloat(listing.getAttribute('data-price'));

      // Default filtering by name
      if (filterBy === 'name' && title.includes(searchValue.toLowerCase())) {
        listing.style.display = 'block';
      } else if (isPriceFilter && searchValue) {
        let priceMatch = false;

        // Price filtering based on < or > operator
        if (searchValue.startsWith('<')) {
          const maxPrice = parseFloat(searchValue.slice(1));
          if (price < maxPrice) priceMatch = true;
        } else if (searchValue.startsWith('>')) {
          const minPrice = parseFloat(searchValue.slice(1));
          if (price > minPrice) priceMatch = true;
        } else {
          listing.style.display = 'none'; // Hide if not a valid price filter input
        }

        if (priceMatch) {
          listing.style.display = 'block';
        } else {
          listing.style.display = 'none';
        }
      } else {
        // Default fallback: Hide listing if search term doesn't match
        listing.style.display = 'none';
      }
    });
  }

  //Open Listing
  function openListingDialog() {
    document.getElementById('listingDialog').show();
  }

  function openListingModal(listingId) {
    // Fetch listing details using the listing ID
    fetch(`/api/listings/${listingId}`).then(response => response.json()).then(listing => {
        const modalContent = `
          <h2 class="text-xl font-semibold">${listing.title}</h2>
          <p><strong>Description:</strong> ${listing.description}</p>
          <p><strong>Price:</strong> $${listing.price} per night</p>
          <p><strong>Photos:</strong></p>
          <div class="flex flex-wrap gap-2">
            ${listing.photos.split(',').map(photo => `<img src="${photo}" class="w-32 h-32 object-cover rounded-lg" />`).join('')}
          </div>
        `;
        document.getElementById('listingModalContent').innerHTML = modalContent;
        document.getElementById('listingModal').show();
      }).catch(err => {
        console.error('Error fetching listing details:', err);
        alert('An error occurred. Please try again.');
      });
  }

  document.getElementById("createListingForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;

    const data = {
      title: form.querySelector('[name="title"]').value,
      name: form.querySelector('[name="name"]').value,
      description: form.querySelector('[name="description"]').value,
      photos: form.querySelector('[name="photos"]').value.split(","),
      price: parseFloat(form.querySelector('[name="price"]').value),
      host_id: parseInt(form.querySelector('[name="host_id"]').value)
    };

    try {
      const response = await fetch("/api/listings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify(data)
      });

      if (response.ok) {
        alert("Listing created successfully!");
        location.reload();
      } else {
        const err = await response.json();
        alert("Error: " + (err.message || "Something went wrong."));
      }
    } catch (err) {
      console.error(err);
      alert("Network error. Please try again.");
    }
  });
  //Delete Listing
  async function deleteListing(id) {
    if (!confirm("Are you sure you want to delete this listing?")) return;

    try {
      const response = await fetch(`/api/listings/${id}`, {
        method: "DELETE",
        credentials: "include"
      });

      if (response.ok) {
        alert("Listing deleted successfully!");
        location.reload();
      } else {
        const err = await response.json();
        alert("Error: " + (err.message || "Something went wrong."));
      }
    } catch (err) {
      console.error(err);
      alert("Network error. Please try again.");
    }
  }

  //Delete Booking
  async function cancelBooking(bookingId, button) {
    if (!confirm("Are you sure you want to cancel this booking?")) return;

    try {
      const response = await fetch(`/api/bookings/${bookingId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (response.ok) {
        alert("Booking cancelled!");

        // Find the closest card and remove it
        const card = button.closest('sl-card');
        if (card) {
          card.remove();
        }
      } else {
        const err = await response.json();
        alert("Error: " + (err.message || "Something went wrong."));
      }
    } catch (err) {
      console.error(err);
      alert("Network error. Please try again.");
    }
  }
  
  document.addEventListener("DOMContentLoaded", () => {
    const tabGroup = document.querySelector("sl-tab-group");
    const fragment = window.location.hash.slice(1);
    if (fragment) {
      tabGroup.show(fragment);
    }

    // Attach delete listeners
    document.querySelectorAll(".delete-button").forEach(button => {
      button.addEventListener("click", () => {
        const listingId = button.getAttribute("data-listing-id");
        deleteListing(listingId);
      });
    });
  });
</script>
{% endblock %}